<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ìœ ì¶• íƒ€ì´ë¨¸</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#F2A58E">
<link rel="apple-touch-icon" href="edit_icon_pump_timer.png">

<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Noto+Serif+KR:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #FFF8F2;
    --warm-rose: #F2A58E;
    --soft-coral: #E8896E;
    --blush: #F7D5C8;
    --deep-rose: #C4614A;
    --warm-brown: #8B5E52;
    --muted-gold: #D4A96A;
    --text-dark: #3D2B24;
    --text-mid: #7A5049;
    --text-light: #B8897D;
    --white: #FFFFFF;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Gowun Dodum', sans-serif;
    background: var(--cream);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden;
    -webkit-user-select: none;
    user-select: none;
  }

  input { user-select: auto; }

  .phone-wrap {
    width: 100%;
    max-width: 390px;
    min-height: 100vh;
    background: var(--cream);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ì¢Œìƒë‹¨ BGM ë²„íŠ¼ */
  .bgm-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 22px;
    z-index: 20;
    cursor: pointer;
    transition: transform 0.2s;
    user-select: none;
  }
  .bgm-btn:active {
    transform: scale(0.9);
  }

  /* ì¢Œìƒë‹¨ ë³¼ë¥¨ ì¡°ì ˆ ë²„íŠ¼ ë° íŒì—… */
  .vol-wrap {
    position: absolute;
    top: 20px;
    left: 60px; /* BGM ë²„íŠ¼ ë°”ë¡œ ìš°ì¸¡ */
    z-index: 20;
  }
  .vol-btn {
    font-size: 22px;
    cursor: pointer;
    transition: transform 0.2s;
    user-select: none;
  }
  .vol-btn:active {
    transform: scale(0.9);
  }
  .vol-popup {
    position: absolute;
    top: 36px;
    left: 50%;
    transform: translateX(-50%) scaleY(0);
    transform-origin: top;
    background: white;
    border-radius: 12px;
    width: 40px; 
    height: 130px;
    box-shadow: 0 4px 16px rgba(196, 97, 74, 0.2);
    opacity: 0;
    transition: transform 0.2s ease, opacity 0.2s ease;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .vol-popup.show {
    transform: translateX(-50%) scaleY(1);
    opacity: 1;
    pointer-events: auto;
  }
  
  /* ê°€ë¡œ ìŠ¬ë¼ì´ë”ë¥¼ -90ë„ íšŒì „ì‹œì¼œ ì„¸ë¡œë¡œ ì™„ë²½ í˜¸í™˜ */
  .slider-container {
    width: 100px;
    height: 20px;
    transform: rotate(-90deg);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #vol-slider {
    width: 100px;
    margin: 0;
    cursor: pointer;
    accent-color: var(--warm-rose); /* ìŠ¬ë¼ì´ë” ìƒ‰ìƒ (ì§€ì› ë¸Œë¼ìš°ì € í•œì •) */
  }

  /* ìš°ìƒë‹¨ ë²„ì „ í…ìŠ¤íŠ¸ */
  .version-tag {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 11px;
    color: var(--text-light);
    z-index: 10;
    font-weight: 300;
  }

  .blob {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
  }
  .blob-1 {
    width: 280px; height: 280px;
    background: radial-gradient(circle, #FBDDD0 0%, transparent 70%);
    top: -80px; right: -60px;
  }
  .blob-2 {
    width: 200px; height: 200px;
    background: radial-gradient(circle, #F7E8D8 0%, transparent 70%);
    bottom: 100px; left: -60px;
  }

  /* ===== PAGE SYSTEM ===== */
  .page {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 28px;
    opacity: 0;
    transform: translateY(20px);
    pointer-events: none;
    transition: opacity 0.45s ease, transform 0.45s ease;
    z-index: 1;
  }
  .page.active {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
  }

  /* ===== START PAGE ===== */
  .logo-area { text-align: center; margin-bottom: 48px; }
  .logo-icon { font-size: 44px; margin-bottom: 10px; display: block; animation: float 3s ease-in-out infinite; }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
  .logo-title { font-family: 'Noto Serif KR', serif; font-size: 22px; color: var(--text-dark); letter-spacing: 2px; font-weight: 600; }
  .logo-sub { font-size: 13px; color: var(--text-light); margin-top: 6px; letter-spacing: 1px; }
  .section-label { font-family: 'Noto Serif KR', serif; font-size: 17px; color: var(--text-dark); text-align: center; margin-bottom: 32px; font-weight: 400; line-height: 1.6; }

  .dir-btns { display: flex; gap: 32px; margin-bottom: 44px; }
  .dir-btn {
    width: 110px; height: 110px; border-radius: 50%; border: none; cursor: pointer;
    font-family: 'Noto Serif KR', serif; font-size: 18px; font-weight: 600; letter-spacing: 1px;
    position: relative; transition: transform 0.2s, box-shadow 0.2s; outline: none;
  }
  .dir-btn-left { background: linear-gradient(135deg, #F2A58E, #E8796A); color: white; box-shadow: 0 8px 28px rgba(232, 121, 106, 0.35); }
  .dir-btn-right { background: linear-gradient(135deg, #D4A96A, #C49050); color: white; box-shadow: 0 8px 28px rgba(196, 144, 80, 0.35); }
  .dir-btn:active { transform: scale(0.93); }
  .dir-btn-label { font-size: 12px; font-weight: 300; display: block; margin-top: 3px; opacity: 0.85; letter-spacing: 0; font-family: 'Gowun Dodum', sans-serif; }

  .time-input-area { display: flex; align-items: center; gap: 10px; background: white; border-radius: 20px; padding: 16px 24px; box-shadow: 0 4px 20px rgba(196, 97, 74, 0.1); }
  .time-label { font-size: 15px; color: var(--text-mid); }
  .time-input { width: 56px; border: none; border-bottom: 2px solid var(--warm-rose); background: transparent; font-family: 'Noto Serif KR', serif; font-size: 22px; color: var(--deep-rose); text-align: center; outline: none; font-weight: 600; }

  .footer-notice { margin-top: auto; padding-bottom: 20px; text-align: center; font-size: 11px; color: var(--text-light); line-height: 1.8; }

  /* ===== TIMER PAGE ===== */
  #page-timer { padding-bottom: 140px; }
  .timer-header { text-align: center; margin-bottom: 36px; }
  .timer-direction { font-size: 13px; color: var(--text-light); letter-spacing: 2px; margin-bottom: 6px; }
  .timer-side { font-family: 'Noto Serif KR', serif; font-size: 26px; color: var(--text-dark); font-weight: 600; }

  .circle-wrap { position: relative; width: 240px; height: 240px; margin-bottom: 40px; }
  .circle-bg { position: absolute; inset: 0; border-radius: 50%; background: white; box-shadow: 0 12px 40px rgba(196, 97, 74, 0.15), inset 0 0 0 2px #F5E0D8; }
  .circle-svg { position: absolute; inset: 0; transform: rotate(-90deg); }
  .circle-track { fill: none; stroke: #F5E0D8; stroke-width: 8; }
  .circle-progress { fill: none; stroke: var(--warm-rose); stroke-width: 8; stroke-linecap: round; stroke-dasharray: 691; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
  .circle-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .time-display { font-family: 'Noto Serif KR', serif; font-size: 52px; font-weight: 300; color: var(--text-dark); letter-spacing: 2px; }
  .time-unit { font-size: 13px; color: var(--text-light); margin-top: 6px; }

  .session-stats { font-size: 13px; color: var(--text-mid); text-align: center; line-height: 1.8; margin-top: 10px; padding: 10px; border-radius: 12px; width: 100%; max-width: 320px; }

  .bottom-actions { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 390px; padding: 20px 28px 36px; background: linear-gradient(to top, var(--cream) 75%, transparent); display: flex; flex-direction: column; gap: 10px; z-index: 10; }
  .btn-primary { width: 100%; padding: 17px; border: none; border-radius: 18px; background: linear-gradient(135deg, #F2A58E, #E8796A); color: white; font-family: 'Noto Serif KR', serif; font-size: 17px; font-weight: 600; cursor: pointer; box-shadow: 0 6px 24px rgba(232, 121, 106, 0.35); transition: transform 0.18s; }
  .btn-secondary { width: 100%; padding: 14px; border: 2px solid var(--blush); border-radius: 18px; background: transparent; color: var(--text-mid); font-family: 'Gowun Dodum', sans-serif; font-size: 15px; cursor: pointer; }
  .btn-primary:active, .btn-secondary:active { transform: scale(0.97); }

  .stats-inline { text-align: center; font-size: 12px; color: var(--text-light); padding-top: 4px; }
  .hidden { display: none !important; }
  .btn-row { display: flex; gap: 12px; width: 100%; margin-bottom: 10px; }
  .btn-row button { flex: 1; }
  
  /* ===== DONE PAGE ===== */
  .done-card { background: white; border-radius: 32px; padding: 40px 32px; box-shadow: 0 16px 50px rgba(196, 97, 74, 0.12); text-align: center; width: 100%; z-index: 2; }
  .done-icon { font-size: 52px; margin-bottom: 20px; display: block; animation: float 3s ease-in-out infinite; }
  .done-title { font-family: 'Noto Serif KR', serif; font-size: 22px; color: var(--text-dark); font-weight: 600; margin-bottom: 28px; }
  .done-stats { background: var(--cream); border-radius: 20px; padding: 22px 24px; margin-bottom: 24px; }
  .done-stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--blush); }
  .done-stat-row:last-child { border-bottom: none; }
  .done-stat-label { font-size: 15px; color: var(--text-mid); }
  .done-stat-value { font-family: 'Noto Serif KR', serif; font-size: 17px; color: var(--deep-rose); font-weight: 600; }
  .done-total-row { display: flex; justify-content: space-between; margin-top: 16px; padding-top: 12px; border-top: 2px solid var(--blush); }
  .done-total-label { font-size: 14px; color: var(--text-light); }
  .done-total-value { font-family: 'Noto Serif KR', serif; font-size: 20px; color: var(--warm-brown); font-weight: 600; }
  .done-love { font-size: 15px; color: var(--warm-rose); margin-top: 6px; animation: pulse 2s ease-in-out infinite; }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  .ping-ring { position: absolute; inset: -12px; border-radius: 50%; border: 3px solid var(--warm-rose); animation: ping 1.2s ease-out infinite; display: none; }
  .ping-ring.show { display: block; }
  @keyframes ping { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.4); opacity: 0; } }

  /* ===== ìƒˆë¡œ ì¶”ê°€ëœ UI ë° ì• ë‹ˆë©”ì´ì…˜ ===== */
  
  /* 1. ì•Œë¦¼ìŒ í™•ì¸ ë²„íŠ¼ */
  .test-alarm-wrap { margin-top: 24px; text-align: center; }
  .btn-test { background: transparent; border: 1.5px solid var(--soft-coral); color: var(--deep-rose); padding: 10px 18px; border-radius: 20px; font-size: 13px; font-weight: 600; font-family: 'Gowun Dodum', sans-serif; cursor: pointer; transition: all 0.2s; }
  .btn-test:active { background: var(--blush); transform: scale(0.95); }

  /* 2. ì‚¬ìš´ë“œ ë³µêµ¬(Wake) ëª¨ë‹¬ì°½ */
  .audio-modal-overlay { position: fixed; inset: 0; background: rgba(61, 43, 36, 0.5); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(3px); }
  .audio-modal-overlay.show { opacity: 1; pointer-events: auto; }
  .audio-modal { background: white; padding: 28px 32px; border-radius: 24px; text-align: center; box-shadow: 0 12px 40px rgba(0,0,0,0.15); transform: translateY(20px); transition: transform 0.3s ease; width: 85%; max-width: 320px; }
  .audio-modal-overlay.show .audio-modal { transform: translateY(0); }
  .audio-modal-text { font-size: 16px; color: var(--text-dark); margin-bottom: 24px; line-height: 1.6; font-weight: 600; }
  .btn-wake-audio { background: linear-gradient(135deg, #F2A58E, #E8796A); color: white; border: none; padding: 16px 24px; border-radius: 18px; font-size: 16px; font-family: 'Noto Serif KR', serif; font-weight: 600; cursor: pointer; width: 100%; box-shadow: 0 6px 20px rgba(232, 121, 106, 0.35); transition: transform 0.15s; }
  .btn-wake-audio:active { transform: scale(0.95); }

  /* 3. íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ì‹¬ì¥ë°•ë™ ë°°ê²½ ê¹œë¹¡ì„ ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes pulse-bg-anim {
    0%, 100% { background-color: var(--cream); }
    25% { background-color: #F7D5C8; /* blush ìƒ‰ìƒ (ë¶€ë“œëŸ¬ìš´ í•‘í¬) */ }
    50% { background-color: var(--cream); }
    75% { background-color: #E8896E; /* soft-coral ìƒ‰ìƒ (ì¡°ê¸ˆ ë” ì§™ì€ ìƒ‰) */ }
  }
  .pulse-bg { animation: pulse-bg-anim 2.5s ease-in-out; }

</style>
</head>
<body>
<div class="phone-wrap">
  <!-- 1. BGM ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ -->
  <div class="bgm-btn" id="bgm-btn" onclick="toggleBGM()">ğŸµ</div>
  
  <!-- 2. ë³¼ë¥¨ íŒì—… ìŠ¬ë¼ì´ë” ì˜ì—­ -->
  <div class="vol-wrap" id="vol-wrap">
    <div class="vol-btn" id="vol-btn" onclick="toggleVolPopup()">ğŸ”‰</div>
    <div class="vol-popup" id="vol-popup">
      <div class="slider-container">
        <input type="range" id="vol-slider" min="0" max="1" step="0.05" value="0.5">
      </div>
    </div>
  </div>

  <div class="version-tag">v.1.2</div>
  
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>

  <!-- ì‹œì‘ í˜ì´ì§€ -->
  <div class="page active" id="page-start">
    <div class="logo-area">
      <span class="logo-icon">ğŸ¤±</span>
      <div class="logo-title">ìœ ì¶• íƒ€ì´ë¨¸</div>
      <div class="logo-sub">ì†Œì¤‘í•œ ì‹œê°„ì„ í•¨ê»˜í•´ìš”</div>
    </div>

    <div class="section-label">ìœ ì¶• ì‹œì‘ ë°©í–¥ì„<br>ì„ íƒí•´ ì£¼ì„¸ìš”</div>

    <div class="dir-btns">
      <button class="dir-btn dir-btn-left" onclick="handleBtnClick(() => startTimer('left'))">ì™¼ìª½<span class="dir-btn-label">â—€ LEFT</span></button>
      <button class="dir-btn dir-btn-right" onclick="handleBtnClick(() => startTimer('right'))">ì˜¤ë¥¸ìª½<span class="dir-btn-label">RIGHT â–¶</span></button>
    </div>

    <div class="time-input-area">
      <span class="time-label">1íšŒ ìœ ì¶• ì‹œê°„</span>
      <input type="number" class="time-input" id="duration-input" value="5" min="1" max="60">
      <span class="time-label">ë¶„</span>
    </div>

    <!-- ì¶”ê°€í•  ìœ„ì¹˜: ì•Œë¦¼ìŒ í™•ì¸ ë²„íŠ¼ -->
    <div class="test-alarm-wrap">
      <button class="btn-test" onclick="handleBtnClick(testAlarmSound)">ğŸ”” ì•Œë¦¼ìŒ í™•ì¸</button>
    </div>

    <div class="footer-notice"><br>â€» ë¸Œë¼ìš°ì €ë¥¼ ì¼  ìƒíƒœë¡œ ìœ ì§€í•´ì£¼ì„¸ìš”.<br>â€» ìŠ¤ë§ˆíŠ¸í° ë¬´ìŒ ëª¨ë“œë¥¼ í•´ì œí•´ì£¼ì„¸ìš”.<br>â€» ìŠ¤ë§ˆíŠ¸í° ë³¼ë¥¨ì„ ì‚´ì§ ì˜¬ë ¤ì£¼ì„¸ìš”.</div>
  </div>

  <!-- íƒ€ì´ë¨¸ í˜ì´ì§€ -->
  <div class="page" id="page-timer">
    <div class="timer-header">
      <div class="timer-direction">í˜„ì¬ ìœ ì¶• ì¤‘</div>
      <div class="timer-side" id="timer-side-label">ì™¼ìª½ ê°€ìŠ´</div>
    </div>

    <div class="circle-wrap">
      <div class="circle-bg"></div>
      <div class="ping-ring" id="ping-ring"></div>
      <svg class="circle-svg" viewBox="0 0 240 240">
        <circle class="circle-track" cx="120" cy="120" r="110"/>
        <circle class="circle-progress" id="circle-prog" cx="120" cy="120" r="110"/>
      </svg>
      <div class="circle-center">
        <div class="time-display" id="time-display">05:00</div>
        <div class="time-unit">ë‚¨ì€ ì‹œê°„</div>
      </div>
    </div>

    <div class="session-stats" id="session-stats"></div>

    <div class="bottom-actions" id="timer-actions-container">
      <div id="running-actions">
        <div class="btn-row">
          <button class="btn-secondary" id="btn-pause" onclick="handleBtnClick(togglePause)">ì¼ì‹œì •ì§€</button>
          <button class="btn-primary" onclick="handleBtnClick(startOpposite)">ë°˜ëŒ€ìª½ ì‹œì‘</button>
        </div>
        <button class="btn-secondary" onclick="handleBtnClick(endSession)">ì¢…ë£Œí•˜ê¸°</button>
      </div>
      
      <div id="end-actions" class="hidden">
        <button class="btn-primary" onclick="handleBtnClick(startOpposite)">ë°˜ëŒ€ìª½ ì‹œì‘</button>
        <button class="btn-secondary" style="margin-top:10px;" onclick="handleBtnClick(endSession)">ì „ì²´ ì¢…ë£Œ</button>
        <div class="stats-inline" id="stats-inline-text"></div>
      </div>
    </div>
  </div>

  <!-- ì™„ë£Œ í˜ì´ì§€ -->
  <div class="page" id="page-done">
    <div class="done-card">
      <span class="done-icon">ğŸ’•</span>
      <div class="done-title">ì˜¤ëŠ˜ë„ ìˆ˜ê³ í•˜ì…¨ì–´ìš”</div>
      <div class="done-stats" id="done-stats-area"></div>
      <div class="done-love">ì—„ë§ˆ ê³ ë§ˆì›Œìš” â™¥</div>
      <div style="margin-top: 32px; width: 100%;">
        <button class="btn-primary" onclick="handleBtnClick(resetApp)">ì²˜ìŒìœ¼ë¡œ</button>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë””ì˜¤ ë³µêµ¬ ëª¨ë‹¬ì°½ (í‰ì†Œì—” ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
  <div class="audio-modal-overlay" id="audio-modal">
    <div class="audio-modal">
      <div class="audio-modal-text">ì˜¤ë””ì˜¤ê°€ ë¹„í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì•Œë¦¼ì„ ìœ„í•´ ì‚¬ìš´ë“œë¥¼ ì¼œì£¼ì„¸ìš”.</div>
      <button class="btn-wake-audio" onclick="wakeUpAudio()">ì‚¬ìš´ë“œ ë‹¤ì‹œ ì¼œê¸° ğŸ””</button>
    </div>
  </div>

</div>

<script>
  // ìƒíƒœ ê´€ë¦¬ ë° DOM ìš”ì†Œ ìºì‹±
  const DOM = {};
  let state = {
    currentSide: '',
    durationMin: 5,
    timerInterval: null,
    secondsLeft: 0,
    totalSeconds: 0,
    isPaused: false,
    sessions: { left: { count: 0, seconds: 0 }, right: { count: 0, seconds: 0 } }
  };

  const CIRCUMFERENCE = 2 * Math.PI * 110;
  let wakeLock = null;
  let audioCtx = null;

  // --- BGM ë° ë³¼ë¥¨ ë³€ìˆ˜ ì„¸íŒ… ---
  const bgmPlaylist = ['song01.mp3', 'song02.mp3', 'song03.mp3', 'song04.mp3', 'song05.mp3', 'song06.mp3'];
  let currentBgmIndex = Math.floor(Math.random() * bgmPlaylist.length); // ëœë¤ ì‹œì‘
  let isBgmPlaying = false;
  
  const bgmAudio = new Audio();
  bgmAudio.crossOrigin = "anonymous"; // ëª¨ë°”ì¼ ë³¼ë¥¨ ì œì–´ ë³´ì•ˆ ì—ëŸ¬ ë°©ì§€
  bgmAudio.volume = 0.5; // PC ê¸°ë³¸ ë³¼ë¥¨ 50%

  let bgmGainNode = null;
  let bgmSourceNode = null;

  // ë…¸ë˜ê°€ ëë‚˜ë©´ ëœë¤ ê³¡(ì—°ì† ê°™ì€ê³¡ ë°©ì§€)ìœ¼ë¡œ ë‹¤ìŒ ê³¡ ì¬ìƒ
  bgmAudio.addEventListener('ended', () => {
    let nextIndex;
    do { nextIndex = Math.floor(Math.random() * bgmPlaylist.length); } while (nextIndex === currentBgmIndex);
    currentBgmIndex = nextIndex;
    bgmAudio.src = bgmPlaylist[currentBgmIndex];
    bgmAudio.play().catch(e => console.warn('BGM ì¬ìƒ ì˜¤ë¥˜:', e));
  });

  // --- ì´ˆê¸°í™” ---
  window.addEventListener('DOMContentLoaded', () => {
    DOM.durationInput = document.getElementById('duration-input');
    DOM.timerSideLabel = document.getElementById('timer-side-label');
    DOM.timeDisplay = document.getElementById('time-display');
    DOM.circleProg = document.getElementById('circle-prog');
    DOM.sessionStats = document.getElementById('session-stats');
    DOM.runningActions = document.getElementById('running-actions');
    DOM.endActions = document.getElementById('end-actions');
    DOM.pingRing = document.getElementById('ping-ring');
    DOM.btnPause = document.getElementById('btn-pause');
    DOM.statsInlineText = document.getElementById('stats-inline-text');
    DOM.doneStatsArea = document.getElementById('done-stats-area');
    
    // BGM & ë³¼ë¥¨ DOM ìºì‹±
    DOM.bgmBtn = document.getElementById('bgm-btn');
    DOM.volWrap = document.getElementById('vol-wrap');
    DOM.volBtn = document.getElementById('vol-btn');
    DOM.volPopup = document.getElementById('vol-popup');
    DOM.volSlider = document.getElementById('vol-slider');

    requestNotificationPermission();
    setupVolumeControl(); // ë³¼ë¥¨ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
  });

  // --- BGMì„ Web Audio APIì— ì—°ê²° (ëª¨ë°”ì¼ ë³¼ë¥¨ ì œì–´ í•µì‹¬ ë¡œì§) ---
  function connectBgmToWebAudio() {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (!bgmSourceNode) {
        bgmSourceNode = audioCtx.createMediaElementSource(bgmAudio);
        bgmGainNode = audioCtx.createGain();
        bgmGainNode.gain.value = parseFloat(DOM.volSlider ? DOM.volSlider.value : 0.5);
        bgmSourceNode.connect(bgmGainNode);
        bgmGainNode.connect(audioCtx.destination);
      }
    } catch (e) {
      console.warn('Web Audio API ì—°ê²° ì˜¤ë¥˜:', e);
    }
  }

  // --- BGM ì¬ìƒ / ì¼ì‹œì •ì§€ ---
  function toggleBGM() {
    warmAudio(); 
    connectBgmToWebAudio(); // ëª¨ë°”ì¼ ê°•ì œ ë³¼ë¥¨ ì œì–´ë¥¼ ìœ„í•œ ì—°ê²°

    if (!isBgmPlaying) {
      if (!bgmAudio.src || bgmAudio.src === window.location.href) {
        bgmAudio.src = bgmPlaylist[currentBgmIndex];
      }
      bgmAudio.play().catch(e => console.warn('BGM ì¬ìƒ ì˜¤ë¥˜:', e));
      DOM.bgmBtn.textContent = 'â¸ï¸';
      isBgmPlaying = true;
    } else {
      bgmAudio.pause();
      DOM.bgmBtn.textContent = 'ğŸµ';
      isBgmPlaying = false;
    }
  }

  // --- ë³¼ë¥¨ ì¡°ì ˆ ê¸°ëŠ¥ ---
  function toggleVolPopup() {
    if(DOM.volPopup) DOM.volPopup.classList.toggle('show');
  }

  function setupVolumeControl() {
    if (!DOM.volSlider) return;

    // ëª¨ë°”ì¼/PC ì™„ë²½ í˜¸í™˜ì„ ìœ„í•´ input/change ë™ì‹œ ë°”ì¸ë”©
    ['input', 'change'].forEach(evt => {
      DOM.volSlider.addEventListener(evt, (e) => {
        const vol = parseFloat(e.target.value);
        
        bgmAudio.volume = vol; // PC í™˜ê²½ ëŒ€ì‘
        if (bgmGainNode && audioCtx) {
           // iOS/ì•ˆë“œë¡œì´ë“œ ëª¨ë°”ì¼ í™˜ê²½ì˜ ë³¼ë¥¨ì„ ê°•ì œ ì œì–´
           bgmGainNode.gain.setValueAtTime(vol, audioCtx.currentTime);
        }
        
        if (vol === 0) DOM.volBtn.textContent = 'ğŸ”‡';
        else if (vol < 0.3) DOM.volBtn.textContent = 'ğŸ”ˆ';
        else if (vol < 0.7) DOM.volBtn.textContent = 'ğŸ”‰';
        else DOM.volBtn.textContent = 'ğŸ”Š';
      });
    });

    // í™”ë©´ ë¹ˆ ê³³ í´ë¦­ ì‹œ ë³¼ë¥¨ íŒì—… ë‹«ê¸°
    document.addEventListener('click', (e) => {
      if (DOM.volWrap && !DOM.volWrap.contains(e.target)) {
        DOM.volPopup.classList.remove('show');
      }
    });
  }

  // ì•Œë¦¼ ê¶Œí•œ ë° ì „ì†¡
  function requestNotificationPermission() {
    if ("Notification" in window) Notification.requestPermission();
  }
  function sendNotification() {
    if ("Notification" in window && Notification.permission === "granted") {
      navigator.serviceWorker.ready.then((registration) => {
        registration.showNotification("íƒ€ì´ë¨¸ ì™„ë£Œ!", {
          body: `${state.currentSide === 'left' ? 'ì™¼ìª½' : 'ì˜¤ë¥¸ìª½'} ìœ ì¶•ì´ ëë‚¬ìŠµë‹ˆë‹¤.`,
          icon: "edit_icon_pump_timer.png",
          vibrate: [200, 100, 200],
          tag: "timer-done"
        });
      });
    }
  }

  function handleBtnClick(actionFunc) {
    warmAudio();
    playClickBeep();
    if (actionFunc) actionFunc();
  }

  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  async function requestWakeLock() {
    try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); }
    catch (err) { console.warn('WakeLock error:', err); }
  }
  function releaseWakeLock() {
    if (wakeLock !== null) { wakeLock.release(); wakeLock = null; }
  }

  function warmAudio() {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    } catch(e) {}
  }

  function playClickBeep() {
    try {
      const ctx = audioCtx;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = 660; osc.type = 'sine';
      gain.gain.setValueAtTime(0, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.02);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
      osc.start(); osc.stop(ctx.currentTime + 0.12);
    } catch(e) {}
  }

  async function playAlarm() {
    try {
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      const ctx = audioCtx;
      function beep(startTime) {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.value = 880; osc.type = 'sine';
        gain.gain.setValueAtTime(0, startTime);
        gain.gain.linearRampToValueAtTime(0.8, startTime + 0.05);
        gain.gain.setValueAtTime(0.8, startTime + 0.35);
        gain.gain.linearRampToValueAtTime(0, startTime + 0.55);
        osc.start(startTime); osc.stop(startTime + 0.6);
      }
      beep(ctx.currentTime); beep(ctx.currentTime + 0.75);
    } catch(e) {}
  }

  function togglePause() {
    if (!state.isPaused) {
      state.isPaused = true;
      clearInterval(state.timerInterval);
      state.timerInterval = null;
      DOM.btnPause.textContent = 'ë‹¤ì‹œ ì‹œì‘';
      releaseWakeLock();
    } else {
      state.isPaused = false;
      DOM.btnPause.textContent = 'ì¼ì‹œì •ì§€';
      requestWakeLock();
      startInterval();
    }
  }

  function startTimer(side) {
    state.durationMin = parseInt(DOM.durationInput.value) || 5;
    state.currentSide = side;
    DOM.runningActions.classList.remove('hidden');
    DOM.endActions.classList.add('hidden');
    DOM.pingRing.classList.remove('show');
    runTimer();
  }

  function startOpposite() {
    // íƒ€ì´ë¨¸ê°€ ì§„í–‰ ì¤‘(ë‚¨ì€ ì‹œê°„ì´ 0ë³´ë‹¤ í¬ê³  ì²˜ìŒ ì„¸íŒ…ì‹œê°„ë³´ë‹¤ ì‘ìŒ)ì¼ ë•Œ ë„˜ì–´ê°€ë©´ íšŸìˆ˜ 1 ì¦ê°€
    if (state.secondsLeft > 0 && state.secondsLeft < state.totalSeconds) {
      state.sessions[state.currentSide].count++;
    }

    state.currentSide = state.currentSide === 'left' ? 'right' : 'left';
    DOM.runningActions.classList.remove('hidden');
    DOM.endActions.classList.add('hidden');
    DOM.pingRing.classList.remove('show');
    runTimer();
  }

  function runTimer() {
    DOM.timerSideLabel.textContent = state.currentSide === 'left' ? 'ì™¼ìª½ ê°€ìŠ´' : 'ì˜¤ë¥¸ìª½ ê°€ìŠ´';
    showPage('page-timer');
    requestWakeLock();

    state.isPaused = false;
    DOM.btnPause.textContent = 'ì¼ì‹œì •ì§€';

    state.secondsLeft = state.durationMin * 60;
    state.totalSeconds = state.durationMin * 60;
    updateDisplay();
    updateCircle(1);
    
    startInterval();
  }

  function startInterval() {
    if (state.timerInterval) clearInterval(state.timerInterval);
    state.timerInterval = setInterval(() => {
      state.secondsLeft--;
      state.sessions[state.currentSide].seconds++;
      updateDisplay();
      updateCircle(state.secondsLeft / state.totalSeconds);
      if (state.secondsLeft <= 0) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
        state.sessions[state.currentSide].count++;
        onTimerEnd();
      }
    }, 1000);
  }

  function updateDisplay() {
    const m = Math.floor(state.secondsLeft / 60).toString().padStart(2, '0');
    const s = (state.secondsLeft % 60).toString().padStart(2, '0');
    DOM.timeDisplay.textContent = `${m}:${s}`;
    DOM.sessionStats.textContent = getStatsText();
  }

  function updateCircle(ratio) {
    const offset = CIRCUMFERENCE * (1 - ratio);
    DOM.circleProg.style.strokeDashoffset = offset;
    DOM.circleProg.style.strokeDasharray = CIRCUMFERENCE;
  }

  function onTimerEnd() {
    playAlarm();
    sendNotification();
    
    // (ì•ˆë“œë¡œì´ë“œ) ìŠ¤ë§ˆíŠ¸í° ì§„ë™ ì•Œë¦¼ ì¶”ê°€
    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    
    // (ì‹œê° ì•Œë¦¼) í™”ë©´ ë°°ê²½ ì‹¬ì¥ë°•ë™ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    const phoneWrap = document.querySelector('.phone-wrap');
    phoneWrap.classList.add('pulse-bg');
    setTimeout(() => {
      phoneWrap.classList.remove('pulse-bg'); // 2.5ì´ˆ í›„ ì´ˆê¸°í™”
    }, 2500);

    DOM.pingRing.classList.add('show');
    DOM.runningActions.classList.add('hidden');
    DOM.endActions.classList.remove('hidden');
    DOM.statsInlineText.textContent = getStatsText();
  }

  function getStatsText() {
    const L = state.sessions.left;
    const R = state.sessions.right;
    return `ì™¼ìª½ ${Math.floor(L.seconds/60)}ë¶„(${L.count}íšŒ)  Â·  ì˜¤ë¥¸ìª½ ${Math.floor(R.seconds/60)}ë¶„(${R.count}íšŒ)`;
  }

  function endSession() {
    if (state.timerInterval) { 
      clearInterval(state.timerInterval); 
      state.timerInterval = null; 
    }
    
    // ì¤‘ê°„ì— ì¢…ë£Œí•˜ê¸°ë¥¼ ëˆŒë €ì„ ë•Œë„ ì‹œê°„ì´ ì¡°ê¸ˆì´ë¼ë„ í˜ë €ë‹¤ë©´ íšŸìˆ˜ 1 ì¦ê°€
    if (state.secondsLeft > 0 && state.secondsLeft < state.totalSeconds) {
      state.sessions[state.currentSide].count++;
    }

    releaseWakeLock();
    buildDoneStats();
    showPage('page-done');
  }

  function resetApp() {
    state.sessions.left = { count: 0, seconds: 0 };
    state.sessions.right = { count: 0, seconds: 0 };
    state.currentSide = '';
    if (state.timerInterval) clearInterval(state.timerInterval);
    DOM.pingRing.classList.remove('show');
    updateCircle(1);
    showPage('page-start');
  }

  function buildDoneStats() {
    const L = state.sessions.left; 
    const R = state.sessions.right;
    const totalS = L.seconds + R.seconds;
    const totalC = L.count + R.count; // ì´ íšŸìˆ˜ ê³„ì‚°
    
    DOM.doneStatsArea.innerHTML = `
      <div class="done-stat-row">
        <span class="done-stat-label">â—€ ì™¼ìª½ (${L.count}íšŒ)</span>
        <span class="done-stat-value">${Math.floor(L.seconds/60)}ë¶„ ${L.seconds%60}ì´ˆ</span>
      </div>
      <div class="done-stat-row">
        <span class="done-stat-label">ì˜¤ë¥¸ìª½ â–¶ (${R.count}íšŒ)</span>
        <span class="done-stat-value">${Math.floor(R.seconds/60)}ë¶„ ${R.seconds%60}ì´ˆ</span>
      </div>
      <div class="done-total-row">
        <span class="done-total-label">ì´ ìœ ì¶• ì‹œê°„ (${totalC}íšŒ)</span>
        <span class="done-total-value">${Math.floor(totalS/60)}ë¶„ ${totalS%60}ì´ˆ</span>
      </div>
    `;
  }

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
    });
  }

  // --- ì•Œë¦¼ìŒ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ---
  function testAlarmSound() {
    playAlarm();
    if (navigator.vibrate) navigator.vibrate([200, 100, 200]); // í…ŒìŠ¤íŠ¸ ì‹œ ì§„ë™ë„ í•¨ê»˜ ìš¸ë¦¼
  }

  // --- ìˆ˜ë©´ ìƒíƒœ ì˜¤ë””ì˜¤ ê¹¨ìš°ê¸° (ëª¨ë‹¬ ë²„íŠ¼ í´ë¦­ ì‹œ) ---
  function wakeUpAudio() {
    warmAudio(); // ì˜¤ë””ì˜¤ ê°•ì œ í™œì„±í™” (ì‚¬ìš©ì ì œìŠ¤ì²˜)
    playClickBeep(); // ì¼ë°˜ ë²„íŠ¼ í´ë¦­ìŒ ë°œìƒ
    document.getElementById('audio-modal').classList.remove('show');
  }

  // --- í™”ë©´ ë³µê·€(ë°±ê·¸ë¼ìš´ë“œ -> í¬ê·¸ë¼ìš´ë“œ) ê°ì§€ ë° ëª¨ë‹¬ ì²˜ë¦¬ ---
  document.addEventListener('visibilitychange', async () => {
    // 1. í™”ë©´ì´ ë‹¤ì‹œ ë³´ì¼ ë•Œ í™”ë©´ êº¼ì§ ë°©ì§€(WakeLock) ì¬í™œì„±í™”
    if (wakeLock !== null && document.visibilityState === 'visible') {
      await requestWakeLock();
    }
    
    if (document.visibilityState === 'visible') {
      // 2. ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ë©ˆì¶°ìˆë‹¤ë©´(suspended), ëª¨ë‹¬ì°½ ë„ìš°ê¸°
      if (audioCtx && audioCtx.state === 'suspended') {
        document.getElementById('audio-modal').classList.add('show');
      } else {
        // ì´ë¯¸ ì¼œì ¸ìˆë‹¤ë©´ (í˜¹ì‹œ ëª¨ë¥¼ ì˜¤ë¥˜ ë°©ì§€ìš©)
        if (audioCtx) audioCtx.resume();
      }
    }
  });
</script>
</script>
</body>
</html>
